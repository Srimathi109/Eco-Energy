<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Inter',sans-serif;
}
body{
  background:#f4f7f6;
}
.dashboard{
  display:flex;
  height:100vh;
  overflow:hidden;
}

/* Sidebar */
.sidebar{
  width:220px;
  background:#1f9d55;
  color:#fff;
  padding:20px;
  display:flex;
  flex-direction:column;
}
.sidebar h2{margin-bottom:30px;}
.sidebar a{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px;
  color:white;
  text-decoration:none;
  border-radius:8px;
  margin-bottom:10px;
}
.sidebar a.active,
.sidebar a:hover{
  background:rgba(255,255,255,0.2);
}
.sidebar .logout{margin-top:auto;}

/* Main */
.main{
  flex:1;
  padding:24px;
  overflow-y:auto;
}

/* Header */
.page-header-section{
  margin-bottom:32px;
}
.welcome-section{
  margin-bottom:16px;
}
.welcome-section h2{
  font-size:28px;
  font-weight:600;
  color:#1f2937;
  margin:0;
}
.welcome-section .username{
  color:#22c55e;
  font-weight:600;
}
.page-header-section h3{
  font-size:24px;
  font-weight:600;
  color:#1f2937;
  margin:0;
}
.user-icon-wrapper{
  position:absolute;
  top:0;
  right:0;
  margin-top:0;
}
.profile-icon{
  width:36px;
  height:36px;
  border-radius:50%;
  background:#22c55e;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-weight:600;
  cursor:pointer;
  transition:transform 0.2s ease;
  position:relative;
}
.profile-icon:hover{
  transform:scale(1.05);
}

/* User Details Dropdown */
.user-details-dropdown{
  position:absolute;
  top:50px;
  right:0;
  background:#fff;
  border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,0.15);
  padding:20px;
  min-width:280px;
  z-index:1000;
  display:none;
  animation:slideDown 0.3s ease;
}
.user-details-dropdown.show{
  display:block;
}
@keyframes slideDown{
  from{
    opacity:0;
    transform:translateY(-10px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}
.user-details-header{
  display:flex;
  align-items:center;
  gap:12px;
  padding-bottom:16px;
  border-bottom:1px solid #e5e7eb;
  margin-bottom:16px;
}
.user-avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  background:#22c55e;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-weight:600;
  font-size:18px;
}
.user-info h4{
  font-size:16px;
  color:#1f2937;
  margin-bottom:4px;
}
.user-info p{
  font-size:13px;
  color:#6b7280;
}
.user-details-item{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 0;
  border-bottom:1px solid #f3f4f6;
}
.user-details-item:last-child{
  border-bottom:none;
}
.user-details-item .material-icons{
  font-size:20px;
  color:#6b7280;
}
.user-details-item span{
  font-size:14px;
  color:#374151;
}
.user-details-item strong{
  color:#1f2937;
  font-weight:600;
}

/* Summary cards */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:20px;
  margin-bottom:32px;
}
.card{
  background:#fff;
  padding:24px;
  border-radius:16px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  border:1px solid #e5e7eb;
  position:relative;
  overflow:hidden;
  transition:transform 0.2s ease, box-shadow 0.2s ease;
}
.card:hover{
  transform:translateY(-2px);
  box-shadow:0 4px 16px rgba(0,0,0,0.12);
}
.card::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  width:4px;
  height:100%;
  background:linear-gradient(180deg,#22c55e,#16a34a);
}
.card-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:16px;
}
.card-icon{
  width:48px;
  height:48px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg,#ecfdf5,#d1fae5);
  color:#15803d;
  font-size:24px;
}
.card h4{
  font-size:13px;
  color:#6b7280;
  font-weight:500;
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin:0;
}
.card-value{
  font-size:32px;
  font-weight:700;
  color:#1f2937;
  margin:8px 0 4px 0;
  line-height:1.2;
}
.card-subtitle{
  font-size:13px;
  color:#9ca3af;
  margin:0;
}
.card.card-primary .card-icon{
  background:linear-gradient(135deg,#ecfdf5,#d1fae5);
  color:#16a34a;
}
.card.card-primary::before{
  background:linear-gradient(180deg,#22c55e,#16a34a);
}
.card.card-success .card-icon{
  background:linear-gradient(135deg,#ecfdf5,#d1fae5);
  color:#16a34a;
}
.card.card-success::before{
  background:linear-gradient(180deg,#22c55e,#16a34a);
}
.card.card-primary,
.card.card-success{
  background:linear-gradient(135deg,#f0fdf4,#ecfdf5);
  border-color:#d1fae5;
}
.card.card-warning .card-icon{
  background:linear-gradient(135deg,#fef3c7,#fde68a);
  color:#d97706;
}
.card.card-warning::before{
  background:linear-gradient(180deg,#f59e0b,#d97706);
}

/* Common section */
.section{
  background:#fff;
  padding:24px;
  border-radius:16px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  border:1px solid #e5e7eb;
}
.section h4{
  font-size:18px;
  font-weight:600;
  color:#1f2937;
  margin-bottom:20px;
  display:flex;
  align-items:center;
  gap:8px;
}
.section h4 .material-icons{
  font-size:22px;
  color:#22c55e;
}

/* ================= GRID FIX ================= */
.dashboard-grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  grid-template-rows:auto auto;
  gap:20px;
}

/* Weekly */
.weekly{
  grid-column:1;
  grid-row:1;
  height:320px;
}
.chart-container{flex:1;}
.weekly{
  height:420px;           /* BIG analytics card */
  display:flex;
  flex-direction:column;
}

.weekly .chart-container{
  flex:1;
  position:relative;
}

.weekly canvas{
  height:100% !important;
}



/* History */
.history{
  grid-column:1;
  grid-row:2;
  max-height:320px;
  overflow-y:auto;
}

/* AI Insights */
.ai-insight{
  grid-column:2;
  grid-row:1 / span 2;
  display:flex;
  flex-direction:column;
}
.ai-box{
  background:linear-gradient(135deg,#f0fdf4,#ecfdf5);
  border:1px solid #d1fae5;
  padding:20px;
  border-radius:12px;
  flex:1;
  overflow-y:auto;
  min-height:200px;
}
.ai-insight-item{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  background:#fff;
  border-radius:8px;
  margin-bottom:12px;
  box-shadow:0 1px 3px rgba(0,0,0,0.05);
  transition:transform 0.2s ease, box-shadow 0.2s ease;
}
.ai-insight-item:hover{
  transform:translateX(4px);
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.ai-insight-item:last-child{
  margin-bottom:0;
}
.ai-insight-icon{
  width:40px;
  height:40px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  flex-shrink:0;
}
.ai-insight-item.safe .ai-insight-icon{
  background:#d1fae5;
}
.ai-insight-item.abnormal .ai-insight-icon{
  background:#fee2e2;
}
.ai-insight-item.zero .ai-insight-icon{
  background:#f3f4f6;
}
.ai-insight-item.efficient .ai-insight-icon{
  background:#dbeafe;
}
.ai-insight-content{
  flex:1;
}
.ai-insight-label{
  font-size:13px;
  color:#6b7280;
  margin-bottom:2px;
}
.ai-insight-value{
  font-size:18px;
  font-weight:600;
  color:#1f2937;
}
.ai-box-empty{
  text-align:center;
  padding:40px 20px;
  color:#9ca3af;
}
.ai-box-empty .material-icons{
  font-size:48px;
  color:#d1d5db;
  margin-bottom:12px;
}

/* Table */
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
}
thead{
  background:#f9fafb;
}
th{
  padding:12px 16px;
  text-align:left;
  font-size:13px;
  font-weight:600;
  color:#374151;
  text-transform:uppercase;
  letter-spacing:0.5px;
  border-bottom:2px solid #e5e7eb;
  position:sticky;
  top:0;
  background:#f9fafb;
}
td{
  padding:14px 16px;
  border-bottom:1px solid #f3f4f6;
  font-size:14px;
  color:#1f2937;
}
tbody tr{
  transition:background-color 0.15s ease;
}
tbody tr:hover{
  background-color:#f9fafb;
}
tbody tr:last-child td{
  border-bottom:none;
}
.table-lab-badge{
  display:inline-block;
  padding:4px 12px;
  border-radius:12px;
  font-size:12px;
  font-weight:500;
  background:#ecfdf5;
  color:#15803d;
}

@media(max-width:900px){
  .dashboard-grid{
    grid-template-columns:1fr;
  }
  .ai-insight{
    grid-column:1;
    grid-row:auto;
  }
}
/* Sidebar header */
.sidebar-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
}

.toggle-btn{
  cursor:pointer;
  transition:transform 0.3s ease;
}

/* Collapsed sidebar */
.sidebar.collapsed{
  width:70px;
  transition:width 0.3s ease;
}

.sidebar{
  transition:width 0.3s ease;
}

/* Hide text when collapsed */
.sidebar.collapsed .link-text,
.sidebar.collapsed .logo-text{
  display:none;
}

/* Center icons when collapsed */
.sidebar.collapsed a{
  justify-content:center;
}

/* Rotate arrow */
.sidebar.collapsed .toggle-btn{
  transform:rotate(180deg);
}

</style>
</head>

<body>
<div class="dashboard">

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-header">
  <span class="logo-text">EcoPanel</span>
  <span class="material-icons toggle-btn" onclick="toggleSidebar()">chevron_left</span>
</div>
  <a class="active"><span class="material-icons">dashboard</span>
    <span class="link-text">Dashboard</span></a>
  <a href="calculate.html"><span class="material-icons">calculate</span>
    <span class="link-text" >Calculate</span></a>
  <a href="analytics.html"><span class="material-icons">analytics</span>
    <span class="link-text">Analytics</span></a>
  <a href="history.html"><span class="material-icons">history</span>
    <span class="link-text">History</span></a>
  <a href="ai-insights.html"><span class="material-icons">psychology</span>
    <span class="link-text">AI Insights</span></a>
  <a class="logout" href="index.html"><span class="material-icons">logout</span>
    <span class="link-text">Logout</span></a>
</div>

<!-- MAIN -->
<div class="main">
<div style="position:relative; margin-bottom:32px;">
  <div class="welcome-section">
    <h2>Welcome back, <span class="username" id="welcomeUsername">User</span></h2>
  </div>
  <div class="page-header-section">
    <h3>Overview</h3>
  </div>
  <div class="user-icon-wrapper">
    <div class="profile-icon" id="profileIcon" onclick="toggleUserDetails()">U</div>
    <div class="user-details-dropdown" id="userDetailsDropdown">
      <div class="user-details-header">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-info">
          <h4 id="userName">Loading...</h4>
          <p id="userEmail">Loading...</p>
        </div>
      </div>
      <div class="user-details-item">
        <span class="material-icons">email</span>
        <span id="userEmailDetail">-</span>
      </div>
      <div class="user-details-item">
        <span class="material-icons">verified_user</span>
        <span>Email Verified: <strong id="emailVerified">-</strong></span>
      </div>
      <div class="user-details-item">
        <span class="material-icons">access_time</span>
        <span>Last Login: <strong id="lastLogin">-</strong></span>
      </div>
    </div>
  </div>
</div>

<!-- CARDS -->
<div class="cards">
  <div class="card card-primary">
    <div class="card-header">
      <div>
        <h4>Today's Consumption</h4>
        <div class="card-value" id="todayConsumption">0 kWh</div>
        <p class="card-subtitle">Energy used today</p>
      </div>
      <div class="card-icon">
        <span class="material-icons">bolt</span>
      </div>
    </div>
  </div>
  <div class="card card-success">
    <div class="card-header">
      <div>
        <h4>Total Cost</h4>
        <div class="card-value" id="todayCost">â‚¹0</div>
        <p class="card-subtitle">Estimated cost today</p>
      </div>
      <div class="card-icon">
        <span class="material-icons">payments</span>
      </div>
    </div>
  </div>
</div>

<!-- GRID -->
<div class="dashboard-grid">

  <!-- Weekly Analytics -->
  <div class="section weekly">
    <h4>
      <span class="material-icons">bar_chart</span>
      Weekly Energy Usage
    </h4>
    <div class="chart-container">
      <canvas id="weeklyChart"></canvas>
    </div>
  </div>

  <!-- AI Insights -->
  <div class="section ai-insight">
    <h4>
      <span class="material-icons">psychology</span>
      AI Energy Insights
    </h4>
    <div class="ai-box" id="aiSummary">
      <div class="ai-box-empty">
        <span class="material-icons">hourglass_empty</span>
        <p>Loading AI insights...</p>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="section history">
  <h4>
    <span class="material-icons">history</span>
    Recent Records
  </h4>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Lab</th>        <!-- Added Lab column -->
        <th>Energy</th>
        <th>Cost</th>
      </tr>
    </thead>
    <tbody id="dashboardHistory"></tbody>
  </table>
</div>
<script>
function toggleSidebar(){
  const sidebar = document.querySelector('.sidebar');
  sidebar.classList.toggle('collapsed');
}

// User Details Toggle
function toggleUserDetails(){
  const dropdown = document.getElementById('userDetailsDropdown');
  dropdown.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event){
  const profileIcon = document.getElementById('profileIcon');
  const dropdown = document.getElementById('userDetailsDropdown');
  
  if(!profileIcon.contains(event.target) && !dropdown.contains(event.target)){
    dropdown.classList.remove('show');
  }
});

// Load user details
function loadUserDetails(user){
  if(!user) return;
  
  // Update avatar with first letter of email or name
  const displayName = user.displayName || user.email || 'User';
  const firstLetter = displayName.charAt(0).toUpperCase();
  document.getElementById('userAvatar').textContent = firstLetter;
  document.getElementById('profileIcon').textContent = firstLetter;
  
  // Update welcome username
  const welcomeUsernameEl = document.getElementById('welcomeUsername');
  if(welcomeUsernameEl){
    const username = user.displayName || user.email?.split('@')[0] || 'User';
    welcomeUsernameEl.textContent = username;
  }
  
  // Update user info
  document.getElementById('userName').textContent = user.displayName || 'User';
  document.getElementById('userEmail').textContent = user.email || '-';
  document.getElementById('userEmailDetail').textContent = user.email || '-';
  document.getElementById('emailVerified').textContent = user.emailVerified ? 'Yes' : 'No';
  
  // Get last login time (using metadata)
  if(user.metadata && user.metadata.lastSignInTime){
    const lastLogin = new Date(user.metadata.lastSignInTime);
    document.getElementById('lastLogin').textContent = lastLogin.toLocaleString();
  } else {
    document.getElementById('lastLogin').textContent = 'Just now';
  }
}
</script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="app.js"></script>
<script>
  firebase.auth().onAuthStateChanged(async user => {
  if (!user) return;

  // Load user details
  loadUserDetails(user);

  const snap = await db.collection("AIInsights").doc(user.uid).get();
  const aiSummaryDiv = document.getElementById("aiSummary");
  
  if (!snap.exists) {
    aiSummaryDiv.innerHTML = `
      <div class="ai-box-empty">
        <span class="material-icons">info</span>
        <p>No AI insights available yet</p>
        <p style="font-size:12px; margin-top:8px;">Generate insights from the AI Insights page</p>
      </div>
    `;
    return;
  }

  const ai = snap.data().summary;

  aiSummaryDiv.innerHTML = `
    <div class="ai-insight-item safe">
      <div class="ai-insight-icon">
        <span class="material-icons">check_circle</span>
      </div>
      <div class="ai-insight-content">
        <div class="ai-insight-label">Safe Labs</div>
        <div class="ai-insight-value">${ai.safe?.length || 0}</div>
      </div>
    </div>
    <div class="ai-insight-item abnormal">
      <div class="ai-insight-icon">
        <span class="material-icons">warning</span>
      </div>
      <div class="ai-insight-content">
        <div class="ai-insight-label">Abnormal Activity</div>
        <div class="ai-insight-value">${ai.abnormal?.length || 0}</div>
      </div>
    </div>
    <div class="ai-insight-item zero">
      <div class="ai-insight-icon">
        <span class="material-icons">power_off</span>
      </div>
      <div class="ai-insight-content">
        <div class="ai-insight-label">Zero Consumption</div>
        <div class="ai-insight-value">${ai.zero?.length || 0}</div>
      </div>
    </div>
    <div class="ai-insight-item efficient">
      <div class="ai-insight-icon">
        <span class="material-icons">trending_down</span>
      </div>
      <div class="ai-insight-content">
        <div class="ai-insight-label">Efficient Labs</div>
        <div class="ai-insight-value">${ai.efficient?.length || 0}</div>
      </div>
    </div>
  `;
});

</script>

</div>
</div>
</div>



</body>
</html>
