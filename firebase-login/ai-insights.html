<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Insights</title>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#f4f7f6; font-family:Inter; margin:0 }
.dashboard { display:flex; height:100vh; overflow:hidden; }
.sidebar {
  width:220px;
  background:#1f9d55;
  color:#fff;
  padding:20px;
  display:flex;
  flex-direction:column;
}
.sidebar a {
  color:#fff;
  text-decoration:none;
  padding:10px;
  border-radius:8px;
  margin-bottom:10px;
  display:flex;
  gap:8px;
  align-items:center;
}
.sidebar a.active { background:rgba(255,255,255,.2); }
.sidebar .logout { margin-top:auto; }

.main { flex:1; padding:24px; overflow-y:auto; }

.sidebar-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
}
.toggle-btn{
  cursor:pointer;
  transition:transform 0.3s ease;
}
.sidebar.collapsed{
  width:70px;
  transition:width 0.3s ease;
}
.sidebar{
  transition:width 0.3s ease;
}
.sidebar.collapsed .link-text,
.sidebar.collapsed .logo-text{
  display:none;
}
.sidebar.collapsed a{
  justify-content:center;
}
.sidebar.collapsed .toggle-btn{
  transform:rotate(180deg);
}

/* Header */
.page-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:24px;
}
.page-header h1 {
  font-size:28px;
  color:#1f2937;
  font-weight:700;
}
.refresh-btn {
  background:#1f9d55;
  color:white;
  border:none;
  padding:10px 20px;
  border-radius:8px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:500;
  transition:background 0.2s;
}
.refresh-btn:hover { background:#15803d; }
.refresh-btn:disabled { opacity:0.6; cursor:not-allowed; }

/* Summary Cards */
.summary-cards {
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
  gap:16px;
  margin-bottom:24px;
}
.summary-card {
  background:linear-gradient(135deg, #ecfdf5, #d1fae5);
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}
.summary-card.alert { background:linear-gradient(135deg, #fef2f2, #fee2e2); }
.summary-card.info { background:linear-gradient(135deg, #eff6ff, #dbeafe); }
.summary-card.success { background:linear-gradient(135deg, #f0fdf4, #dcfce7); }
.summary-card h4 {
  font-size:14px;
  color:#065f46;
  margin-bottom:8px;
  font-weight:600;
}
.summary-card.alert h4 { color:#991b1b; }
.summary-card.info h4 { color:#1e40af; }
.summary-card.success h4 { color:#166534; }
.summary-card .value {
  font-size:32px;
  font-weight:700;
  color:#15803d;
  margin-bottom:4px;
}
.summary-card.alert .value { color:#dc2626; }
.summary-card.info .value { color:#2563eb; }
.summary-card.success .value { color:#16a34a; }
.summary-card .subtext {
  font-size:12px;
  color:#6b7280;
  margin-top:4px;
}

/* Section Styles */
.section {
  background:#fff;
  padding:24px;
  border-radius:14px;
  margin-bottom:20px;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
.section h3 {
  font-size:20px;
  color:#1f2937;
  margin-bottom:16px;
  display:flex;
  align-items:center;
  gap:8px;
}
.loading {
  color:#6b7280;
  font-style:italic;
  padding:20px;
  text-align:center;
}

/* Lab Cards */
.lab-card {
  background:#f9fafb;
  border-left:4px solid #22c55e;
  padding:16px;
  border-radius:10px;
  margin-bottom:12px;
  transition:transform 0.2s, box-shadow 0.2s;
  cursor:pointer;
}
.lab-card:hover {
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
.lab-card.abnormal { border-left-color:#ef4444; }
.lab-card.efficient { border-left-color:#3b82f6; }
.lab-card.zero { border-left-color:#6b7280; }
.lab-card-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.lab-card-title {
  font-weight:600;
  font-size:16px;
  color:#1f2937;
}
.lab-card-priority {
  background:#ef4444;
  color:white;
  padding:4px 10px;
  border-radius:12px;
  font-size:11px;
  font-weight:600;
  text-transform:uppercase;
}
.lab-card-priority.medium { background:#f59e0b; }
.lab-card-priority.low { background:#10b981; }
.lab-card-reason {
  color:#6b7280;
  font-size:14px;
  margin-bottom:12px;
  line-height:1.5;
}
.lab-card-details {
  display:none;
  margin-top:12px;
  padding-top:12px;
  border-top:1px solid #e5e7eb;
}
.lab-card.expanded .lab-card-details {
  display:block;
}
.lab-metrics {
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
  gap:12px;
  margin-bottom:12px;
}
.metric {
  background:white;
  padding:10px;
  border-radius:8px;
}
.metric-label {
  font-size:11px;
  color:#6b7280;
  text-transform:uppercase;
  margin-bottom:4px;
}
.metric-value {
  font-size:18px;
  font-weight:600;
  color:#1f2937;
}
.recommendations {
  background:#fef3c7;
  padding:12px;
  border-radius:8px;
  margin-top:12px;
}
.recommendations h5 {
  font-size:13px;
  color:#92400e;
  margin-bottom:8px;
  display:flex;
  align-items:center;
  gap:6px;
}
.recommendations ul {
  margin-left:20px;
  color:#78350f;
  font-size:13px;
  line-height:1.6;
}
.recommendations li {
  margin-bottom:6px;
}
.cost-savings {
  background:#d1fae5;
  padding:12px;
  border-radius:8px;
  margin-top:12px;
}
.cost-savings h5 {
  font-size:13px;
  color:#065f46;
  margin-bottom:4px;
}
.cost-savings .savings-amount {
  font-size:20px;
  font-weight:700;
  color:#15803d;
}

.empty-state {
  text-align:center;
  padding:40px;
  color:#9ca3af;
}
.empty-state .material-icons {
  font-size:48px;
  margin-bottom:12px;
  opacity:0.5;
}

/* Trend Chart Container */
.trend-section {
  margin-top:20px;
}
.chart-container {
  position:relative;
  height:300px;
  margin-top:16px;
}

/* Filter Tabs */
.filter-tabs {
  display:flex;
  gap:8px;
  margin-bottom:20px;
  flex-wrap:wrap;
}
.filter-tab {
  padding:8px 16px;
  background:#f3f4f6;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
  color:#6b7280;
  transition:all 0.2s;
}
.filter-tab.active {
  background:#1f9d55;
  color:white;
}
.filter-tab:hover:not(.active) {
  background:#e5e7eb;
}

/* Comparison Grid */
.comparison-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
  gap:16px;
  margin-top:20px;
}

@media (max-width:768px) {
  .main { padding:16px; }
  .page-header h1 { font-size:22px; }
  .summary-cards { grid-template-columns:1fr; }
  .lab-metrics { grid-template-columns:1fr; }
}
</style>
</head>

<body>
<div class="dashboard">
<div class="sidebar">
  <div class="sidebar-header">
    <span class="logo-text">EcoPanel</span>
    <span class="material-icons toggle-btn" onclick="toggleSidebar()">chevron_left</span>
  </div>

  <a href="dashboard.html"><span class="material-icons">dashboard</span>
   <span class="link-text">Dashboard</span></a>
  <a href="calculate.html"><span class="material-icons">calculate</span>
     <span class="link-text">Calculate</span></a>
  <a href="analytics.html"><span class="material-icons">analytics</span>
     <span class="link-text">Analytics</span></a>
  <a href="history.html"><span class="material-icons">history</span>
     <span class="link-text">History</span></a>
  <a class="active"><span class="material-icons">psychology</span>
     <span class="link-text">AI Insights</span></a>

  <a class="logout" href="index.html">
    <span class="material-icons">logout</span>
    <span class="link-text">Logout</span>
  </a>
</div>

<div class="main">
  <div class="page-header">
    <h1>AI Energy Insights</h1>
    <div style="display:flex; gap:12px;">
      <button class="refresh-btn" id="exportBtn" onclick="exportInsights()" style="background:#6b7280;">
        <span class="material-icons">download</span>
        <span>Export Report</span>
      </button>
      <button class="refresh-btn" id="refreshBtn" onclick="refreshInsights()">
        <span class="material-icons">refresh</span>
        <span>Refresh Analysis</span>
      </button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card alert" id="summaryAbnormal">
      <h4>ðŸ”´ Abnormal Labs</h4>
      <div class="value">-</div>
      <div class="subtext">Requires attention</div>
    </div>
    <div class="summary-card success" id="summarySafe">
      <h4>ðŸŸ¢ Safe Labs</h4>
      <div class="value">-</div>
      <div class="subtext">Operating normally</div>
    </div>
    <div class="summary-card info" id="summaryEfficient">
      <h4>ðŸ”µ Efficient Labs</h4>
      <div class="value">-</div>
      <div class="subtext">Optimal performance</div>
    </div>
    <div class="summary-card" id="summaryZero">
      <h4>âš« Zero Consumption</h4>
      <div class="value">-</div>
      <div class="subtext">May be powered off</div>
    </div>
    <div class="summary-card success" id="summarySavings">
      <h4>ðŸ’° Potential Savings</h4>
      <div class="value">-</div>
      <div class="subtext">Monthly estimate</div>
    </div>
  </div>

  <!-- Trend Chart Section -->
  <div class="section trend-section">
    <h3>ðŸ“ˆ Energy Consumption Trends</h3>
    <div class="chart-container">
      <canvas id="trendChart"></canvas>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div class="filter-tabs">
    <button class="filter-tab active" onclick="filterLabs('all', event)">All Labs</button>
    <button class="filter-tab" onclick="filterLabs('abnormal')">Abnormal</button>
    <button class="filter-tab" onclick="filterLabs('safe')">Safe</button>
    <button class="filter-tab" onclick="filterLabs('efficient')">Efficient</button>
    <button class="filter-tab" onclick="filterLabs('zero')">Zero</button>
  </div>

  <!-- Abnormal Activity -->
  <div class="section" data-category="abnormal">
    <h3>ðŸ”´ Abnormal Activity Detected</h3>
    <div id="abnormalLabs" class="loading">Analyzing energy patterns...</div>
  </div>

  <!-- Safe Labs -->
  <div class="section" data-category="safe">
    <h3>ðŸŸ¢ Safe Labs</h3>
    <div id="safeLabs" class="loading">Analyzing...</div>
  </div>

  <!-- Efficient Labs -->
  <div class="section" data-category="efficient">
    <h3>ðŸ”µ Efficient Labs</h3>
    <div id="efficientLabs" class="loading">Analyzing...</div>
  </div>

  <!-- Zero Consumption -->
  <div class="section" data-category="zero">
    <h3>âš« Zero Consumption Labs</h3>
    <div id="zeroLabs" class="loading">Analyzing...</div>
  </div>
</div>
</div>

<script>
function toggleSidebar(){
  const sidebar = document.querySelector('.sidebar');
  sidebar.classList.toggle('collapsed');
}

function filterLabs(category, event) {
 {
  document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
  event.target.classList.add('active');
  
  document.querySelectorAll('.section[data-category]').forEach(section => {
    if (category === 'all' || section.dataset.category === category) {
      section.style.display = 'block';
    } else {
      section.style.display = 'none';
    }
  });
}

function refreshInsights() {
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="material-icons">hourglass_empty</span><span>Analyzing...</span>';
  
  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) return;
    await loadAIInsights(user);
    btn.disabled = false;
    btn.innerHTML = '<span class="material-icons">refresh</span><span>Refresh Analysis</span>';
  });
}

function exportInsights() {
  if (!window.currentInsightsData) {
    alert('No insights data available. Please wait for analysis to complete.');
    return;
  }

  const data = window.currentInsightsData;
  let report = 'AI ENERGY INSIGHTS REPORT\n';
  report += '='.repeat(50) + '\n\n';
  report += `Generated: ${new Date().toLocaleString()}\n\n`;

  // Summary
  report += 'SUMMARY\n';
  report += '-'.repeat(50) + '\n';
  report += `Abnormal Labs: ${data.summary.abnormal?.length || 0}\n`;
  report += `Safe Labs: ${data.summary.safe?.length || 0}\n`;
  report += `Efficient Labs: ${data.summary.efficient?.length || 0}\n`;
  report += `Zero Consumption Labs: ${data.summary.zero?.length || 0}\n`;
  report += `Potential Monthly Savings: â‚¹${(data.totalSavings || 0).toLocaleString()}\n\n`;

  // Abnormal Labs
  if (data.summary.abnormal && data.summary.abnormal.length > 0) {
    report += 'ABNORMAL LABS\n';
    report += '-'.repeat(50) + '\n';
    data.summary.abnormal.forEach(item => {
      report += `\n${item.lab} (${item.priority || 'N/A'} Priority)\n`;
      report += `  Reason: ${item.reason}\n`;
      report += `  Avg Energy: ${(item.avgEnergy || 0).toFixed(2)} kWh\n`;
      if (item.recommendations && item.recommendations.length > 0) {
        report += `  Recommendations:\n`;
        item.recommendations.forEach(rec => report += `    - ${rec}\n`);
      }
      if (item.savings > 0) {
        report += `  Potential Savings: â‚¹${item.savings.toLocaleString()}/month\n`;
      }
    });
    report += '\n';
  }

  // Safe Labs
  if (data.summary.safe && data.summary.safe.length > 0) {
    report += 'SAFE LABS\n';
    report += '-'.repeat(50) + '\n';
    data.summary.safe.forEach(item => {
      report += `\n${item.lab}\n`;
      report += `  ${item.reason}\n`;
      report += `  Avg Energy: ${(item.avgEnergy || 0).toFixed(2)} kWh\n`;
    });
    report += '\n';
  }

  // Efficient Labs
  if (data.summary.efficient && data.summary.efficient.length > 0) {
    report += 'EFFICIENT LABS\n';
    report += '-'.repeat(50) + '\n';
    data.summary.efficient.forEach(item => {
      report += `\n${item.lab}\n`;
      report += `  ${item.reason}\n`;
      report += `  Avg Energy: ${(item.avgEnergy || 0).toFixed(2)} kWh\n`;
    });
    report += '\n';
  }

  // Zero Labs
  if (data.summary.zero && data.summary.zero.length > 0) {
    report += 'ZERO CONSUMPTION LABS\n';
    report += '-'.repeat(50) + '\n';
    data.summary.zero.forEach(item => {
      report += `\n${item.lab}\n`;
      report += `  ${item.reason}\n`;
      if (item.recommendations && item.recommendations.length > 0) {
        report += `  Recommendations:\n`;
        item.recommendations.forEach(rec => report += `    - ${rec}\n`);
      }
    });
    report += '\n';
  }

  // Create and download file
  const blob = new Blob([report], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `energy-insights-report-${new Date().toISOString().split('T')[0]}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
}
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="app.js"></script>
<script type="module">
import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai@latest?cachebust=20260103";

import { GEMINI_API_KEY } from './config.js';

const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
const db = firebase.firestore();

firebase.auth().onAuthStateChanged(async (user) => {
  if (!user) return window.location.href = "index.html";
  await loadAIInsights(user);
});

async function loadAIInsights(user) {
  const safeDiv = document.getElementById("safeLabs");
  const abnormalDiv = document.getElementById("abnormalLabs");
  const efficientDiv = document.getElementById("efficientLabs");
  const zeroDiv = document.getElementById("zeroLabs");

  try {
    const snap = await db.collection("EnergyRecords")
      .where("uid", "==", user.uid)
      .orderBy("timestamp", "desc")
      .limit(100)
      .get();

    if (snap.empty) {
      safeDiv.innerHTML = abnormalDiv.innerHTML = efficientDiv.innerHTML = zeroDiv.innerHTML = 
        '<div class="empty-state"><span class="material-icons">data_usage</span><p>No energy data available for analysis</p></div>';
      return;
    }

    const records = snap.docs.map(d => {
      const data = d.data();
      return {
        ...data,
        timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : new Date(data.timestamp)
      };
    });

    // Group by lab and calculate metrics
    const labData = {};
    const labStats = {};
    
    records.forEach(r => {
      if (!labData[r.lab]) {
        labData[r.lab] = [];
        labStats[r.lab] = {
          total: 0,
          count: 0,
          avg: 0,
          max: 0,
          min: Infinity,
          cost: 0
        };
      }
      labData[r.lab].push(r);
      labStats[r.lab].total += r.energy || 0;
      labStats[r.lab].count++;
      labStats[r.lab].max = Math.max(labStats[r.lab].max, r.energy || 0);
      labStats[r.lab].min = Math.min(labStats[r.lab].min, r.energy || 0);
      labStats[r.lab].cost += r.cost || 0;
    });

    Object.keys(labStats).forEach(lab => {
      labStats[lab].avg = labStats[lab].total / labStats[lab].count;
    });

    // Calculate overall average for comparison
    const overallAvg = Object.values(labStats).reduce((sum, stat) => sum + stat.avg, 0) / Object.keys(labStats).length;

    const prompt = `You are an expert AI energy auditor analyzing lab energy consumption data.

For EACH LAB, analyze the data and provide:
1. Classification: SAFE, ABNORMAL, ZERO, or EFFICIENT
2. Detailed reason with specific metrics
3. Priority level: HIGH, MEDIUM, or LOW
4. Actionable recommendations (2-3 specific items)
5. Estimated monthly cost savings if recommendations are followed (in rupees)

Energy Data Summary:
${JSON.stringify(Object.keys(labStats).map(lab => ({
  lab: lab,
  averageConsumption: labStats[lab].avg.toFixed(2),
  maxConsumption: labStats[lab].max.toFixed(2),
  minConsumption: labStats[lab].min.toFixed(2),
  totalCost: labStats[lab].cost.toFixed(2),
  recordCount: labStats[lab].count,
  recentReadings: labData[lab].slice(0, 5).map(r => ({ energy: r.energy, cost: r.cost }))
})), null, 2)}

Overall Average Consumption: ${overallAvg.toFixed(2)} kWh

Return ONLY valid JSON in this exact format:
{
  "safe": [
    {
      "lab": "Lab Name",
      "reason": "Detailed explanation",
      "priority": "LOW",
      "avgEnergy": 2.5,
      "recommendations": ["Recommendation 1", "Recommendation 2"],
      "savings": 0
    }
  ],
  "abnormal": [
    {
      "lab": "Lab Name",
      "reason": "Detailed explanation with metrics",
      "priority": "HIGH",
      "avgEnergy": 5.5,
      "recommendations": ["Action item 1", "Action item 2", "Action item 3"],
      "savings": 1500
    }
  ],
  "zero": [
    {
      "lab": "Lab Name",
      "reason": "Explanation",
      "priority": "MEDIUM",
      "avgEnergy": 0,
      "recommendations": ["Recommendation"],
      "savings": 0
    }
  ],
  "efficient": [
    {
      "lab": "Lab Name",
      "reason": "Explanation",
      "priority": "LOW",
      "avgEnergy": 1.2,
      "recommendations": ["Best practice to share"],
      "savings": 0
    }
  ]
}`;

    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
    const result = await model.generateContent(prompt);
    const text = result.response.text();

    // Extract JSON from response
    let json;
    try {
      const jsonStart = text.indexOf("{");
      const jsonEnd = text.lastIndexOf("}") + 1;
      json = JSON.parse(text.substring(jsonStart, jsonEnd));
    } catch (e) {
      // Fallback parsing
      const codeBlock = text.match(/```json\s*([\s\S]*?)\s*```/) || text.match(/```\s*([\s\S]*?)\s*```/);
      if (codeBlock) {
        json = JSON.parse(codeBlock[1]);
      } else {
        throw new Error("Could not parse AI response");
      }
    }

    // Update summary cards
    document.getElementById("summaryAbnormal").querySelector(".value").textContent = json.abnormal?.length || 0;
    document.getElementById("summarySafe").querySelector(".value").textContent = json.safe?.length || 0;
    document.getElementById("summaryEfficient").querySelector(".value").textContent = json.efficient?.length || 0;
    document.getElementById("summaryZero").querySelector(".value").textContent = json.zero?.length || 0;
    
    const totalSavings = (json.abnormal || []).reduce((sum, item) => sum + (item.savings || 0), 0) +
                        (json.zero || []).reduce((sum, item) => sum + (item.savings || 0), 0);
    document.getElementById("summarySavings").querySelector(".value").textContent = `â‚¹${totalSavings.toLocaleString()}`;

    // Render sections with enhanced cards
    renderEnhancedList(abnormalDiv, json.abnormal || [], "No abnormal activity detected", "abnormal", labStats);
    renderEnhancedList(safeDiv, json.safe || [], "All labs are operating within safe parameters", "safe", labStats);
    renderEnhancedList(efficientDiv, json.efficient || [], "No labs identified as particularly efficient", "efficient", labStats);
    renderEnhancedList(zeroDiv, json.zero || [], "No labs showing zero consumption", "zero", labStats);

    // Save insights
    await db.collection("AIInsights").doc(user.uid).set({
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      summary: json,
      labStats: labStats,
      totalSavings: totalSavings
    }, { merge: true });

    // Store for export
    window.currentInsightsData = {
      summary: json,
      labStats: labStats,
      totalSavings: totalSavings
    };

    // Render trend chart
    renderTrendChart(records, labStats);

  } catch (err) {
    console.error("AI Insights Error:", err);
    safeDiv.innerHTML = abnormalDiv.innerHTML = efficientDiv.innerHTML = zeroDiv.innerHTML = 
      `<div class="empty-state"><span class="material-icons">error</span><p>Error generating insights: ${err.message}</p></div>`;
  }
}

// Trend Chart Function
let trendChartInstance = null;

function renderTrendChart(records, labStats) {
  const canvas = document.getElementById('trendChart');
  if (!canvas) return;

  // Group records by date
  const dailyData = {};
  const labColors = {
    'Computer Lab': '#22c55e',
    'Electronics Lab': '#3b82f6',
    'Physics Lab': '#f59e0b',
    'Chemistry Lab': '#ef4444'
  };

  records.forEach(record => {
    const date = new Date(record.timestamp);
    const dateKey = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    
    if (!dailyData[dateKey]) {
      dailyData[dateKey] = {};
    }
    
    if (!dailyData[dateKey][record.lab]) {
      dailyData[dateKey][record.lab] = 0;
    }
    
    dailyData[dateKey][record.lab] += record.energy || 0;
  });

  // Get all unique dates and labs
  const dates = Object.keys(dailyData).sort((a, b) => {
    return new Date(a) - new Date(b);
  });
  const labs = Object.keys(labStats);

  // Prepare datasets for each lab
  const datasets = labs.map(lab => ({
    label: lab,
    data: dates.map(date => dailyData[date]?.[lab] || 0),
    borderColor: labColors[lab] || '#6b7280',
    backgroundColor: labColors[lab] ? labColors[lab] + '40' : '#6b728040',
    tension: 0.4,
    fill: false
  }));

  // Destroy existing chart if it exists
  if (trendChartInstance) {
    trendChartInstance.destroy();
  }

  // Create new chart
  trendChartInstance = new Chart(canvas, {
    type: 'line',
    data: {
      labels: dates,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Energy (kWh)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Date'
          }
        }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      }
    }
  });
}

function renderEnhancedList(div, items, emptyMsg, category, labStats) {
  div.classList.remove("loading");
  
  if (!items || items.length === 0) {
    div.innerHTML = `<div class="empty-state"><span class="material-icons">check_circle</span><p>${emptyMsg}</p></div>`;
    return;
  }

  div.innerHTML = items.map((item, index) => {
    const stats = labStats[item.lab] || {};
    const priorityClass = item.priority?.toLowerCase() || 'low';
    
    return `
      <div class="lab-card ${category}" data-index="${index}" onclick="toggleCard(this)">
        <div class="lab-card-header">
          <div class="lab-card-title">${item.lab}</div>
          ${item.priority ? `<div class="lab-card-priority ${priorityClass}">${item.priority}</div>` : ''}
        </div>
        <div class="lab-card-reason">${item.reason}</div>
        <div class="lab-card-details">
          <div class="lab-metrics">
            <div class="metric">
              <div class="metric-label">Avg Energy</div>
              <div class="metric-value">${(item.avgEnergy || stats.avg || 0).toFixed(2)} kWh</div>
            </div>
            <div class="metric">
              <div class="metric-label">Max Energy</div>
              <div class="metric-value">${(stats.max || 0).toFixed(2)} kWh</div>
            </div>
            <div class="metric">
              <div class="metric-label">Total Cost</div>
              <div class="metric-value">â‚¹${(stats.cost || 0).toFixed(2)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Records</div>
              <div class="metric-value">${stats.count || 0}</div>
            </div>
          </div>
          ${item.recommendations && item.recommendations.length > 0 ? `
            <div class="recommendations">
              <h5><span class="material-icons" style="font-size:16px;">lightbulb</span> Recommendations</h5>
              <ul>
                ${item.recommendations.map(rec => `<li>${rec}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          ${item.savings > 0 ? `
            <div class="cost-savings">
              <h5>Potential Monthly Savings</h5>
              <div class="savings-amount">â‚¹${item.savings.toLocaleString()}</div>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function toggleCard(card) {
  card.classList.toggle('expanded');
}

// Make toggleCard available globally
window.toggleCard = toggleCard;
</script>

</body>
</html>